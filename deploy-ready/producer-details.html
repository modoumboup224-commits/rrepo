<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Détails du producteur</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        body {
            background-image: url('images/bg.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }

        main {
            position: relative;
            z-index: 1;
        }

        /* Gallery Styles */
        .producer-gallery {
            margin: 20px 0;
            text-align: center;
        }

        .main-producer-image {
            max-width: 400px;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .no-image {
            width: 400px;
            height: 300px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: #666;
            font-style: italic;
            margin: 0 auto;
        }

        .producer-info {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .producer-info h3 {
            color: #26331a;
            margin-top: 0;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
        }

        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .product-card h4 {
            margin: 10px 0;
            color: #26331a;
        }

        .product-card .price {
            font-weight: bold;
            color: #4CAF50;
        }

        .contact-section {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .contact-section h3 {
            color: #26331a;
            margin-top: 0;
        }
    </style>
</head>

<body>
    <!-- Inclusion du header commun -->
    <div id="header-placeholder"></div>

    <main
        style="max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h1>Détails du producteur</h1>

        <section id="producer-details" style="margin-bottom: 30px;">
            <h2 id="producer-name">Chargement...</h2>

            <!-- Galerie d'images -->
            <div id="producer-images-container" class="producer-gallery">
                <!-- Les images seront chargées ici -->
            </div>

            <div class="producer-info">
                <h3>Informations du producteur</h3>
                <p><strong>Nom:</strong> <span id="producer-name-detail"></span></p>
                <p><strong>Localisation:</strong> <span id="producer-location"></span></p>
                <p><strong>Description:</strong> <span id="producer-description"></span></p>
            </div>

            <section id="producer-products">
                <h3>Produits de ce producteur</h3>
                <div id="products-list" class="products-grid">
                    <!-- Produits chargés dynamiquement -->
                </div>
            </section>

            <div class="contact-section">
                <h3>Contact</h3>
                <p>Pour toute question ou commande spéciale, n'hésitez pas à nous contacter.</p>
                <button id="contact-btn" style="background-color: #26331a; color: white; border: none; padding: 12px 24px; 
                               border-radius: 25px; cursor: pointer; font-size: 16px; transition: all 0.3s ease;"
                    onmouseover="this.style.backgroundColor='#1a2412'"
                    onmouseout="this.style.backgroundColor='#26331a'">
                    Contacter le producteur
                </button>
            </div>
        </section>
    </main>

    <!-- Inclusion du footer commun -->
    <div id="footer-placeholder"></div>

    <script>
        // Chargement dynamique du header et footer
        async function loadHTML(id, url) {
            const response = await fetch(url);
            const text = await response.text();
            document.getElementById(id).innerHTML = text;
        }
        loadHTML('header-placeholder', 'header.html');
        loadHTML('footer-placeholder', 'footer.html');

        // Function to get query parameters from URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        async function fetchProducerDetails(producerId) {
            try {
                const response = await fetch('/api/producteurs/' + producerId);
                if (!response.ok) {
                    throw new Error('Producteur non trouvé');
                }
                const producer = await response.json();
                return producer;
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function fetchProducerProducts(producerId) {
            try {
                const response = await fetch(`/api/products?producer=${producerId}&limit=6`);
                if (!response.ok) {
                    throw new Error('Produits non trouvés');
                }
                const products = await response.json();
                return products;
            } catch (error) {
                console.error(error);
                return [];
            }
        }

        function displayProducerDetails(producer) {
            if (!producer) {
                document.getElementById('producer-details').innerHTML = '<p>Producteur non trouvé.</p>';
                return;
            }

            document.getElementById('producer-name').textContent = producer.nom || 'N/A';
            document.getElementById('producer-name-detail').textContent = producer.nom || 'N/A';
            document.getElementById('producer-location').textContent = producer.localisation || 'N/A';
            document.getElementById('producer-description').textContent =
                `Découvrez les produits frais et locaux de ${producer.nom}, situé à ${producer.localisation}. 
                Nous nous engageons à vous offrir des produits de qualité, cultivés avec soin et respect de l'environnement.` || 'N/A';

            // Affichage des images
            displayProducerImages(producer);
        }

        function displayProducerImages(producer) {
            const container = document.getElementById('producer-images-container');

            if (producer.photoUrl) {
                container.innerHTML = `
                    <div class="producer-gallery">
                        <img src="${producer.photoUrl}" alt="${producer.photoAlt || 'Photo du producteur'}" 
                             class="main-producer-image">
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="no-image">
                        Aucune image disponible
                    </div>
                `;
            }
        }

        function displayProducerProducts(products) {
            const productsList = document.getElementById('products-list');

            if (products.length === 0) {
                productsList.innerHTML = '<p>Aucun produit disponible pour le moment.</p>';
                return;
            }

            productsList.innerHTML = '';
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.images && product.images.length > 0 ? product.images[0] : 'images/logo.png'}" 
                         alt="${product.name}">
                    <h4>${product.name}</h4>
                    <p class="price">€${product.price ? product.price.toFixed(2) : 'N/A'}</p>
                    <button onclick="viewProduct('${product._id}')" 
                            style="background-color: #26331a; color: white; border: none; padding: 8px 16px; 
                                   border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        Voir le produit
                    </button>
                `;
                productsList.appendChild(productCard);
            });
        }

        function viewProduct(productId) {
            window.location.href = `product-details-working.html?id=${productId}`;
        }

        document.getElementById('contact-btn').addEventListener('click', () => {
            alert('Fonctionnalité de contact en cours de développement. Veuillez utiliser le formulaire de commande.');
        });

        async function init() {
            const producerId = getQueryParam('id');
            if (!producerId) {
                document.getElementById('producer-details').innerHTML = '<p>ID de producteur manquant dans l\'URL.</p>';
                return;
            }

            const producer = await fetchProducerDetails(producerId);
            displayProducerDetails(producer);

            if (producer) {
                const products = await fetchProducerProducts(producerId);
                displayProducerProducts(products);
            }
        }

        window.onload = init;
    </script>
</body>

</html>